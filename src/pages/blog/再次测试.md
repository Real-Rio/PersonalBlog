---
layout: ../../layouts/PostLayout.astro
title: 再次测试
description: don't go into that night gently
tags:
  - netlify
pubDate: 2023.01.04
updatedDate: ""
heroImage: /images/post_img.webp
---
## 技术栈

前端 electron

后端 C++ websocket

linux内核模块 C++



## 一些待解决问题

**应用程序如何与内核程序通信？**

1. 编写系统调用
2. 编写驱动程序
3. netlink
4. 使用proc文件系统
5. 内存映射（共享内存）

**web与后端如何通信？**

http or websocket?

前端想要及时获取后端更新的状态一般有两种方法：第一种是轮询，隔段时间前端发送一个请求查询。第二种是用websocket，后端主动发送消息给前端。

- libhttpserver https://github.com/etr/libhttpserver

  ```
  ./bootstrap
  mkdir build
  cd build
  ../configure
  make
  make install # (optionally to install on the system)
  
  ```

  

- libmicrohttpd 0.9.71(libhttpserver依赖)

  ```
  tar -xvzf libmicrohttpd-0.9.68.tar.gz
  cd libmicrohttpd-0.9.68
  mkdir build
  cd build
  ../configure
  make
  sudo make install
  sudo ldconfig(添加动态链接库路径)
  ```

  

## 实验中遇到的问题

**Makefile一直失败**

![image-20220820185650430](C:\Users\53094\AppData\Roaming\Typora\typora-user-images\image-20220820185650430.png)

原因是文件路径linux module中有空格，删掉空格后make正常



**`init.h` `skbuff.h`头文件索引不到**

更改vscode的include path



**客户端用netlink向内核发送消息，内核没有反应。用老师给的样例模块则可以**

重复定义`struct net init_net`导致命名空间冲突？



**`rmmod`卸载模块时系统崩溃**

module_exit函数写错了，本应该unregister掉hook函数，写成了register

**编写规则后netfilter不起作用**

如果不指定网卡的话，netfilter拦截的是所有网卡的包吗？





## 总体设计



### netfilter hook过程

1. 接收到新的数据包时检查是否已有连接，有的话说明之前检查过，予以放行；
2. 没有已存在的连接则进行规则匹配，若匹配成功，按规则的动作执行；否则，按默认动作执行。若予以放行，需新建连接。

### 规则

#### 添加规则

> 默认后添加的规则优先级更高，若想指定新添加规则的位置，可以通过设置‘after’指定规则的插入位置

添加规则时要遍历当前已有连接，若新添加规则（drop）与已有连接相冲突，则将该连接节点删除

#### 刪除规则

删除规则时还要删除与规则相匹配的连接



### 连接状态

1. 连接通过红黑树进行储存，新建连接或者命中连接都将过期时间设置为7s



## 课堂检查

- 客户端循环允许，如果用户输入错误，则退出；每输完一条指令需要输入一个字符加回车进入下一个循环

### 演示流程

### 待完成

- [x] rule规则存放在哪

> 内核中，以链表的形式存储

- [x] 日志保存在哪

- [x] 连接状态怎么保存

> 内核中，`conn_helper.c`中定义了连接红黑树的根节点RB_ROOT

- [ ] 管理日志方便添加吗（`helper.c`）
- [ ] 将log输出的tag进行替换
- [x] rbtree 第一个节点root是连到rbnode还是connNode
- [x] `hook_main.c`的默认规则在哪体现

> `unsigned int DEFAULT_ACTION = **NF_ACCEPT**;·`



ip规则

- 增加
- 删除

nat规则

- 增加
- 删除

默认动作